<?xml version="1.0" encoding="UTF-8"?>
<!--
*******************************************************************************
* JMMC project ( http://www.jmmc.fr ) - Copyright (C) CNRS.
*******************************************************************************
-->

<project name="JMCS" default="about" basedir=".">

    <description>
        JMCS ant build file.

        To generate JAXB code from xsd:
        ant -f build-java.xml genXsdCode
    </description>


    <!--
    Get build properties (general).
    Should only contain the location of the JMCS module where JAXB libraries can be found.
    -->
    <property file="build.properties" />

    <!-- define folder properties -->
    <property name="root" location=".."/>

    <!-- JAXB library must be present in the jmcs module nearby -->
    <property name="jaxb.version" value="2.2.11"/>
    <property name="jaxb.libs" location="${jmcs.path}/tools/xjc"/>
    <property name="mvn.libs" location="${root}/target/runtime-libs/"/>

    <!-- JMCS src folder -->
    <property name="sources"   location="${root}/src/main/java"/>

    <property name="output" location="${sources}"/>

    <!-- JMCS test folder -->
    <property name="test" location="${root}/src/test/java"/>


    <!-- custom macro to enhance XJC -->
    <macrodef name="xjc">
        <attribute name="destdir"/>
        <attribute name="schema"/>

        <sequential>
            <java classname="com.sun.tools.xjc.XJCFacade" classpath="${jaxb.libs}/jaxb-xjc-${jaxb.version}.jar:${mvn.libs}/jaxb-api-${jaxb.version}.jar:${mvn.libs}/jaxb-core-${jaxb.version}.jar:${mvn.libs}/jaxb-impl-${jaxb.version}.jar" fork="true" failonerror="true" maxmemory="256m">

                <jvmarg value="-Djavax.xml.accessExternalSchema=all" />

                <arg value="-classpath"/>
                <arg value="${jaxb.libs}/simple-regenerator-1.0.jar"/>

                <arg value="-no-header"/>

                <arg value="-extension"/>
                <!-- preserve code extension -->
                <arg value="-simple-preserve"/>

                <arg value="-d"/>
                <arg value="@{destdir}"/>

                <arg value="@{schema}"/>
                <env key="LANG" value="en_US"/>
            </java>

            <delete dir="@{destdir}">
                <include name="**/*.java.backup"/>
            </delete>
        </sequential>
    </macrodef>




    <!-- targets -->

    <!-- target about : -->
    <target name="about" description="show information for public targets">
        <echo>available ant targets : </echo>
        <echo>-------------------------------------------------------------------------------</echo>
        <echo>  - genXsdCode         : generates the java code from xml schema (xsd)</echo>
        <echo>-------------------------------------------------------------------------------</echo>
        <echo> jaxb libraries : ${jaxb.libs}</echo>
    </target>




    <target name="genXsdCode" description="generate java classes from XSD schemas">

        <echo>generating java code for ApplicationDataModel.xsd</echo>
        <mkdir dir="${output}/fr/jmmc/jmcs/data/app/model" />

        <!-- test -->
        <xjc destdir="${output}"
             schema="${sources}/fr/jmmc/jmcs/data/app/ApplicationDataModel.xsd" />

	    <!-- 
	    remove several @XmlSchemaType in JAXB 2.2.11:
	    - @XmlSchemaType(name = "string") by '' (bad enum)
	    - @XmlSchemaType(name = "anySimpleType") by none (bad double[])
	    -->
<!--
	    <replace summary="true" dir="${output}//fr/jmmc/jmcs/data/app/model/" includes="*.java" value="">
		    <replacetoken>@XmlSchemaType(name = "string")</replacetoken>
	    </replace>
	    <replace summary="true" dir="${output}//fr/jmmc/jmcs/data/app/model/" includes="*.java" value="">
		    <replacetoken>@XmlSchemaType(name = "anySimpleType")</replacetoken>
	    </replace>
-->
    </target>

</project>
